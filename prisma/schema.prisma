// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE TENANT & USER MODELS
// ============================================

model Organization {
  id        String   @id @default(cuid())
  slug      String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships Membership[]
  groups       Group[]
  content      ContentItem[]
  curricula    Curriculum[]
  assignments  Assignment[]
  certificates CertificateTemplate[]
  eventLogs    EventLog[]
  narrationAssets NarrationAsset[]
  controlledDocuments ControlledDocument[]
  storedFiles  StoredFile[]

  @@index([slug])
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  password        String   // hashed
  name            String?
  referralSource  String?  // how they heard about us (signup question)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  memberships Membership[]
  groupMembers GroupMember[]
  formSubmissions FormSubmission[]
  quizAttempts QuizAttempt[]
  attestationRecords AttestationRecord[]
  enrollments Enrollment[]
  certificatesIssued CertificateIssued[]
  eventLogs EventLog[]
  documentAcknowledgments DocumentAcknowledgment[]
  termsAcceptances UserTermsAcceptance[]

  @@index([email])
}

// Terms of Service versions and user acceptances (clickwrap / audit)
model TermsVersion {
  id        String   @id @default(cuid())
  version   String   @unique // e.g. "2026-02-11-v1"
  title     String   // e.g. "MacTech Training Terms of Service"
  content   String   @db.Text // markdown or long text
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())

  acceptances UserTermsAcceptance[]

  @@index([isActive])
}

model UserTermsAcceptance {
  id                String   @id @default(cuid())
  userId            String
  orgId             String?  // optional; set when accepted in org context
  termsVersionId    String
  acceptedAt        DateTime @default(now())
  ipHash            String   // hashed IP for privacy
  userAgent         String   @db.Text
  acceptanceContext String   // e.g. "registration" | "reacceptance"
  createdAt         DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  termsVersion TermsVersion @relation(fields: [termsVersionId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([termsVersionId])
  @@index([userId, termsVersionId])
}

model Membership {
  id     String   @id @default(cuid())
  userId String
  orgId  String
  role   String // "ADMIN" | "TRAINER" | "TRAINEE"

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, orgId])
  @@index([orgId, role])
}

// ============================================
// GROUPS
// ============================================

model Group {
  id        String   @id @default(cuid())
  orgId     String
  name      String
  groupType String?  // Organization, Event, School, Employer, or custom
  joinCode  String?  @unique // short code for QR / join URL
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  members     GroupMember[]
  enrollments Enrollment[]
  assignments Assignment[]

  @@index([orgId])
  @@index([joinCode])
}

model GroupMember {
  id      String @id @default(cuid())
  groupId String
  userId  String

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
}

// ============================================
// LEARNING OBJECTS (MODULAR)
// ============================================

enum ContentType {
  ARTICLE
  SLIDE_DECK
  VIDEO
  FORM
  QUIZ
  ATTESTATION
}

model ContentItem {
  id          String      @id @default(cuid())
  orgId       String
  type        ContentType
  title       String
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  org           Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  article       Article?
  slideDeck     SlideDeck?
  video         Video?
  formTemplate  FormTemplate?
  quiz          Quiz?
  attestationTemplate AttestationTemplate?
  curriculumItems CurriculumItem[]
  enrollmentItemProgress EnrollmentItemProgress[]
  assignments Assignment[]

  @@index([orgId, type])
}

model Article {
  id          String   @id @default(cuid())
  contentItemId String @unique
  content     String   // rich text (markdown or HTML)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  contentItem ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
}

model SlideDeck {
  id            String   @id @default(cuid())
  contentItemId String   @unique
  sourceFileId  String?  // the uploaded PPTX; when set, deck is "PPTX-as-source" (full fidelity)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contentItem ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
  sourceFile  StoredFile? @relation(fields: [sourceFileId], references: [id], onDelete: SetNull)
  slides      Slide[]
}

model Slide {
  id                  String   @id @default(cuid())
  slideDeckId         String
  title               String
  content             String   // rich text (body)
  order               Int
  layoutType          String?  // TITLE, TITLE_AND_BODY, TWO_COLUMN, IMAGE_LEFT_TEXT_RIGHT, etc.
  elementsJson        String?  // future: text boxes, positions, fonts, shapes
  backgroundStyleJson String?  // theme colors, gradient, etc.
  notesRichText       String?  // speaker notes (trainer-only in viewer)
  importedFromPptx    Boolean  @default(false)
  sourceFileId       String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  slideDeck   SlideDeck   @relation(fields: [slideDeckId], references: [id], onDelete: Cascade)
  sourceFile  StoredFile? @relation(fields: [sourceFileId], references: [id], onDelete: SetNull)

  @@index([slideDeckId, order])
}

model StoredFile {
  id                    String   @id @default(cuid())
  orgId                 String
  filename              String
  mimeType              String
  sizeBytes             Int
  storagePath           String   // path on volume or bucket
  createdAt             DateTime @default(now())
  createdByMembershipId String?

  org        Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  slides     Slide[]
  slideDecks SlideDeck[]

  @@index([orgId])
}

model Video {
  id          String   @id @default(cuid())
  contentItemId String @unique
  url         String
  duration    Int?     // seconds
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  contentItem ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
}

model FormTemplate {
  id          String   @id @default(cuid())
  contentItemId String @unique
  description String?
  schemaJson  String   // JSON schema for form fields
  required    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  contentItem ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
  submissions FormSubmission[]
}

model FormSubmission {
  id            String   @id @default(cuid())
  formTemplateId String
  userId        String
  enrollmentId  String?  // link to enrollment if part of training
  answersJson  String   // JSON: field answers
  submittedAt   DateTime @default(now())

  formTemplate FormTemplate @relation(fields: [formTemplateId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([formTemplateId])
  @@index([userId])
  @@index([enrollmentId])
}

model Quiz {
  id          String   @id @default(cuid())
  contentItemId String @unique
  passingScore Int     @default(70) // percentage
  allowRetry  Boolean  @default(false)
  showAnswersAfter Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  contentItem ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
  questions   Question[]
  attempts    QuizAttempt[]
}

model Question {
  id          String   @id @default(cuid())
  quizId      String
  text        String
  type        String   // "MULTIPLE_CHOICE" | "TRUE_FALSE"
  explanation String?  // shown after submission if showAnswersAfter is true
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  quiz    Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  choices Choice[]

  @@index([quizId, order])
}

model Choice {
  id         String   @id @default(cuid())
  questionId String
  text       String
  isCorrect  Boolean
  order      Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId, order])
}

model QuizAttempt {
  id          String   @id @default(cuid())
  quizId      String
  userId      String
  score       Int?     // percentage
  passed      Boolean?
  answers     String   // JSON: { questionId: choiceId }
  submittedAt DateTime @default(now())

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([userId])
}

model AttestationTemplate {
  id          String   @id @default(cuid())
  contentItemId String @unique
  text        String   // acknowledgment text
  requireTypedName Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  contentItem ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
  records     AttestationRecord[]
}

model AttestationRecord {
  id            String   @id @default(cuid())
  templateId    String
  userId        String
  typedName     String?  // typed name if requireTypedName is true
  signature     String?  // signature data
  ipAddress     String?  // IP address if available
  signedAt      DateTime @default(now())

  template AttestationTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user     User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([userId])
}

// ============================================
// NARRATION (TTS)
// ============================================

enum NarrationEntityType {
  SLIDE
  SLIDE_DECK
  ARTICLE
}

model NarrationAsset {
  id          String   @id @default(cuid())
  orgId       String
  entityType  NarrationEntityType
  entityId    String
  voice       String   @default("alloy")
  format      String   @default("mp3")
  storagePath String   // path relative to volume mount or absolute
  updatedAt   DateTime @updatedAt
  updatedByMembershipId String?

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, entityType, entityId])
  @@index([orgId])
  @@index([orgId, entityType, entityId])
}

// ============================================
// CURRICULA
// ============================================

model Curriculum {
  id          String   @id @default(cuid())
  orgId       String
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  sections    CurriculumSection[]
  assignments Assignment[]
  certificateTemplates CertificateTemplate[]

  @@index([orgId])
}

model CurriculumSection {
  id          String   @id @default(cuid())
  curriculumId String
  title       String
  description String?
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  curriculum Curriculum      @relation(fields: [curriculumId], references: [id], onDelete: Cascade)
  items      CurriculumItem[]

  @@index([curriculumId, order])
}

model CurriculumItem {
  id          String   @id @default(cuid())
  sectionId   String
  contentItemId String
  required    Boolean  @default(true)
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  section     CurriculumSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  contentItem ContentItem       @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@index([sectionId, order])
  @@index([contentItemId])
}

// ============================================
// ASSIGNMENTS & PROGRESS
// ============================================

enum AssignmentType {
  CONTENT_ITEM
  CURRICULUM
}

enum AssignmentStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  OVERDUE
}

model Assignment {
  id             String          @id @default(cuid())
  orgId          String
  type           AssignmentType
  contentItemId  String?         // if type is CONTENT_ITEM
  curriculumId   String?         // if type is CURRICULUM
  groupId        String?         // when assigned via "assign curriculum to group"
  title          String
  description    String?
  dueDate        DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  contentItem ContentItem? @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
  curriculum  Curriculum?  @relation(fields: [curriculumId], references: [id], onDelete: Cascade)
  group       Group?       @relation(fields: [groupId], references: [id], onDelete: SetNull)
  enrollments Enrollment[]

  @@index([orgId])
  @@index([contentItemId])
  @@index([curriculumId])
  @@index([groupId])
}

model Enrollment {
  id          String   @id @default(cuid())
  assignmentId String
  userId      String?
  groupId     String?
  status      AssignmentStatus @default(ASSIGNED)
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user       User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  group      Group?      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  itemProgress EnrollmentItemProgress[]
  certificatesIssued CertificateIssued[]

  @@index([assignmentId])
  @@index([userId])
  @@index([groupId])
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  FAILED
}

model EnrollmentItemProgress {
  id          String   @id @default(cuid())
  enrollmentId String
  contentItemId String
  status      ProgressStatus @default(NOT_STARTED)
  completed   Boolean  @default(false) // legacy, kept for compatibility
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  enrollment  Enrollment  @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  contentItem ContentItem  @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, contentItemId])
  @@index([enrollmentId])
  @@index([contentItemId])
}

// ============================================
// CERTIFICATES
// ============================================

model CertificateTemplate {
  id          String   @id @default(cuid())
  orgId       String
  curriculumId String? // when set, this template is used for this curriculum's completion
  name        String
  htmlTemplateRichText String // HTML template with placeholders
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  curriculum Curriculum? @relation(fields: [curriculumId], references: [id], onDelete: SetNull)
  issued    CertificateIssued[]

  @@index([orgId])
  @@index([curriculumId])
}

model CertificateIssued {
  id          String   @id @default(cuid())
  templateId  String
  userId      String
  enrollmentId String? // link to enrollment if from training
  certificateNumber String @unique // unique certificate number
  issuedAt    DateTime @default(now())

  template   CertificateTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user       User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollment Enrollment?        @relation(fields: [enrollmentId], references: [id], onDelete: SetNull)

  @@index([templateId])
  @@index([userId])
  @@index([enrollmentId])
  @@index([certificateNumber])
}

// ============================================
// ARCHIVED MODULES (data retention log for deduplication)
// ============================================
// When duplicate content/curricula/certificates are removed, one version is kept
// and the others are logged here so only the current version appears in the UI.

model ArchivedModuleLog {
  id             String   @id @default(cuid())
  orgId          String
  entityType     String   // "CONTENT_ITEM" | "CURRICULUM" | "CERTIFICATE_TEMPLATE"
  entityId       String   // id of the archived (removed) record
  titleOrName    String   // title (content/curriculum) or name (cert template)
  contentType    String?  // for CONTENT_ITEM: ARTICLE, SLIDE_DECK, QUIZ, etc.
  archivedAt     DateTime @default(now())
  supersededById String   // id of the kept (current) version
  reason         String   @default("DUPLICATE") // e.g. DUPLICATE, SUPERSEDED

  @@index([orgId])
  @@index([entityType])
  @@index([archivedAt])
}

// ============================================
// QMS DOCUMENT CONTROL (ISO 17025 / GDP)
// ============================================

enum DocumentType {
  QAM    // Quality Manual
  POL    // Policy
  SOP    // Standard Operating Procedure
  WIP    // Work Instruction
  FRM    // Form
  RTP    // Record / Template
  METHOD // Test Method / Technical Procedure
}

enum DocumentStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  EFFECTIVE
  OBSOLETE
}

enum DocumentChangeType {
  MINOR
  MAJOR
}

model ControlledDocument {
  id                    String    @id @default(cuid())
  orgId                 String
  documentId            String    // Unique per org, immutable (e.g. QAM-001, SOP-DOC-01)
  title                 String
  documentType          DocumentType
  currentVersionId      String?   // FK to DocumentVersion (current effective/draft version)
  status                DocumentStatus @default(DRAFT)
  effectiveDate         DateTime?
  reviewDueDate         DateTime?
  authorMembershipId    String
  controlledDistribution Boolean  @default(true)
  supersededByDocumentId String?   // Self-reference when obsolete
  retentionPeriodYears  Int       @default(7)
  requiresAcknowledgment Boolean  @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  org                    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  versions               DocumentVersion[]
  currentVersion         DocumentVersion? @relation("CurrentVersion", fields: [currentVersionId], references: [id], onDelete: SetNull)
  supersededBy           ControlledDocument?  @relation("Supersedes", fields: [supersededByDocumentId], references: [id], onDelete: SetNull)
  supersedes             ControlledDocument[] @relation("Supersedes")

  @@unique([orgId, documentId])
  @@index([orgId])
  @@index([orgId, documentType])
  @@index([orgId, status])
}

model DocumentVersion {
  id          String   @id @default(cuid())
  documentId  String
  version     String   // e.g. "1.0", "1.1"
  changeType  DocumentChangeType
  changeSummary String
  changedSections String? // Free text description of changed sections
  content     String   // Full document body (rich text)
  createdByMembershipId String
  createdAt   DateTime @default(now())

  document   ControlledDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentAsCurrent ControlledDocument[] @relation("CurrentVersion")
  approvals  DocumentApprovalRecord[]
  acknowledgments DocumentAcknowledgment[]

  @@unique([documentId, version])
  @@index([documentId])
}

model DocumentApprovalRecord {
  id                  String   @id @default(cuid())
  documentVersionId   String
  approverMembershipId String
  typedName           String
  role                String   // e.g. "Quality Manager"
  meaningOfSignature  String   @default("Approval for use")
  signedAt            DateTime @default(now())

  documentVersion DocumentVersion @relation(fields: [documentVersionId], references: [id], onDelete: Cascade)

  @@index([documentVersionId])
}

model DocumentAcknowledgment {
  id                String   @id @default(cuid())
  documentVersionId String
  userId            String
  acknowledgedAt    DateTime @default(now())
  typedName         String?
  trainerMembershipId String? // If training was delivered

  documentVersion DocumentVersion @relation(fields: [documentVersionId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([documentVersionId, userId])
  @@index([documentVersionId])
  @@index([userId])
}

// ============================================
// AUDIT & RETENTION
// ============================================

enum EventType {
  LOGIN
  LOGOUT
  CONTENT_CREATED
  CONTENT_UPDATED
  CONTENT_DELETED
  CURRICULUM_CREATED
  CURRICULUM_UPDATED
  ASSIGNMENT_CREATED
  ASSIGNMENT_UPDATED
  ENROLLMENT_STARTED
  ENROLLMENT_COMPLETED
  QUIZ_SUBMITTED
  QUIZ_FAILED
  FORM_SUBMITTED
  ATTESTATION_SIGNED
  CERTIFICATE_ISSUED
  USER_CREATED
  USER_UPDATED
  GROUP_CREATED
  GROUP_UPDATED
  NARRATION_GENERATED
  DOCUMENT_CREATED
  DOCUMENT_REVISED
  DOCUMENT_VERSION_APPROVED
  DOCUMENT_EFFECTIVE
  DOCUMENT_OBSOLETED
  DOCUMENT_TRAINING_TRIGGERED
  DOCUMENT_ACKNOWLEDGMENT_COMPLETED
  TERMS_ACCEPTED
}

model EventLog {
  id        String    @id @default(cuid())
  orgId     String?
  userId    String?
  type      EventType
  metadata  String?   // JSON
  createdAt DateTime  @default(now())

  org  Organization? @relation(fields: [orgId], references: [id], onDelete: SetNull)
  user User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([orgId, createdAt])
  @@index([userId, createdAt])
  @@index([type, createdAt])
}
